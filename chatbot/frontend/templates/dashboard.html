<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Document Dashboard</title>

  <!-- Bootstrap & Font Awesome -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet" />

  <!-- AOS Animation -->
  <link href="https://cdn.jsdelivr.net/npm/aos@2.3.4/dist/aos.css" rel="stylesheet" />

  <!-- Particles.js & Lottie -->
  <script src="https://cdn.jsdelivr.net/npm/particles.js@2.0.0/particles.min.js"></script>
  <script src="https://unpkg.com/@lottiefiles/lottie-player@latest/dist/lottie-player.js"></script>

  <style>
    :root {
      --primary: #6366f1;
      --light-bg: #f8fafc;
      --accent: #e0e7ff;
      --danger: #ef4444;
      --success: #10b981;
      --text: #1e293b;
    }

    body {
      font-family: 'Inter', sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f8f9fa;
      overflow-x: hidden;
      position: relative;
    }

    #particles-js {
      position: fixed;
      width: 100%;
      height: 100%;
      z-index: -1;
      top: 0;
      left: 0;
    }

    .dashboard-wrapper {
      background: white;
      border-radius: 20px;
      padding: 2rem;
      margin-top: 2rem;
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.1);
      animation: fadeInUp 0.8s ease;
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(40px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .header-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .btn-logout {
      background-color: var(--danger);
      color: white;
      transition: all 0.3s ease;
    }

    .btn-logout:hover {
      background-color: #b91c1c;
      box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
    }

    .chat-container {
      display: flex;
      flex-direction: column;
      height: 70vh;
    }

    .chat-box {
      flex-grow: 1;
      overflow-y: auto;
      background: #f8f9fa;
      padding: 1rem;
      border-radius: 12px;
      border: 1px solid #dee2e6;
    }

    .message {
      margin-bottom: 1rem;
      display: flex;
    }

    .message p {
      padding: 0.8rem 1.2rem;
      border-radius: 15px;
      max-width: 80%;
      line-height: 1.6;
      font-size: 0.95rem;
      margin: 0;
      white-space: pre-wrap;
      animation: popIn 0.3s ease-in-out;
    }

    @keyframes popIn {
      from {
        transform: scale(0.8);
        opacity: 0;
      }

      to {
        transform: scale(1);
        opacity: 1;
      }
    }

    .message.user {
      justify-content: flex-end;
    }

    .message.user p {
      background-color: var(--primary);
      color: white;
    }

    .message.bot {
      justify-content: flex-start;
    }

    .message.bot p {
      background-color: var(--accent);
      color: var(--text);
    }

    .input-group input:focus,
    select.form-select:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 0.2rem rgba(99, 102, 241, 0.25);
    }

    .file-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      animation: fadeIn 0.5s ease;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .btn-success:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 14px rgba(16, 185, 129, 0.3);
    }

    .lottie-box {
      text-align: center;
      margin-top: 2rem;
    }

    lottie-player {
      width: 200px;
      height: 200px;
    }
  </style>
</head>

<body>
  <div id="particles-js"></div>

  <div class="container">
    <div class="dashboard-wrapper" data-aos="fade-up">
      <div class="header-bar mb-4">
        <h2><i class="fas fa-folder-open me-2"></i>Document Dashboard</h2>
        <a href="/logout" class="btn btn-logout">Logout</a>
      </div>
      <div class="row">
        <!-- Left Column -->
        <div class="col-md-4" data-aos="fade-right">
          <h5 class="mb-3 text-primary">Your Documents</h5>
          <form action="/upload" method="post" enctype="multipart/form-data" class="mb-4">
            <div class="input-group">
              <input type="file" name="file" class="form-control" required />
              <button type="submit" class="btn btn-success">Upload</button>
            </div>
          </form>
          <div id="fileList" class="mb-4"></div>

          <div class="lottie-box">
            <lottie-player src="https://lottie.host/3b20974c-cccf-4d68-8531-18d12fbd3468/5ugAf2hBR4.json"
              background="transparent" speed="1" loop autoplay></lottie-player>
          </div>
        </div>

        <!-- Right Column -->
        <div class="col-md-8" data-aos="fade-left">
          <h5 class="text-success mb-3">Ask Questions</h5>
          <div class="mb-3">
            <label class="form-label">Choose file to search (optional)</label>
            <select name="selected_file" id="selected_file" class="form-select">
              <option value="">All files</option>
            </select>
          </div>
          <div class="chat-container">
            <div class="chat-box" id="chatBox">
              <div class="message bot">
                <p>Hello! Ask me anything about your documents.</p>
              </div>
            </div>
            <form id="chatForm" method="post" class="mt-3">
              <div class="input-group">
                <input type="text" name="query" id="queryInput" class="form-control" placeholder="Ask a question..."
                  required />
                <button type="submit" class="btn btn-primary">Ask</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- JS Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/aos@2.3.4/dist/aos.js"></script>
  <script>AOS.init();</script>

  <script>
    particlesJS("particles-js", {
      particles: {
        number: { value: 60 },
        color: { value: "#6366f1" },
        size: { value: 3 },
        line_linked: {
          enable: true,
          distance: 150,
          color: "#aaa",
          opacity: 0.4,
          width: 1
        },
        move: { enable: true, speed: 2 }
      },
      interactivity: {
        events: {
          onhover: { enable: true, mode: "repulse" }
        }
      }
    });

    async function fetchFiles() {
      const res = await fetch("/files");
      const data = await res.json();
      const listDiv = document.getElementById("fileList");
      const select = document.getElementById("selected_file");
      listDiv.innerHTML = '';
      select.innerHTML = '<option value="">All files</option>';

      data.files.forEach(file => {
        const row = document.createElement("div");
        row.className = "file-row";
        row.innerHTML = `
          <span><i class="fas fa-file-alt me-2 text-secondary"></i>${file.name}</span>
          <a href="/delete-file/${file.id}" class="btn btn-sm btn-outline-danger"><i class="fas fa-trash"></i> Delete</a>
        `;
        listDiv.appendChild(row);

        const opt = document.createElement("option");
        opt.value = file.name;
        opt.innerText = file.name;
        select.appendChild(opt);
      });
    }

    function formatBotText(text) {
      text = text.replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>");
      const lines = text.split('\n').filter(l => l.trim() !== '');
      if (lines.length > 1 && lines.every(line => /^[-\d.]/.test(line.trim()))) {
        return `<ul>` + lines.map(l => `<li>${l.replace(/^[-\d.]+\s*/, '')}</li>`).join('') + `</ul>`;
      }
      return `<p>${text}</p>`;
    }

    document.getElementById("chatForm").addEventListener("submit", async function (e) {
      e.preventDefault();
      const formData = new FormData(this);
      const query = formData.get("query");

      const chatBox = document.getElementById("chatBox");
      const userMsg = document.createElement("div");
      userMsg.className = "message user";
      userMsg.innerHTML = `<p>${query}</p>`;
      chatBox.appendChild(userMsg);

      const botMsg = document.createElement("div");
      botMsg.className = "message bot";
      const bubble = document.createElement("p");
      bubble.innerHTML = `<span class="spinner-border spinner-border-sm me-2"></span>Thinking...`;
      botMsg.appendChild(bubble);
      chatBox.appendChild(botMsg);
      chatBox.scrollTop = chatBox.scrollHeight;

      document.getElementById("queryInput").value = "";

      const res = await fetch("/chat/stream", {
        method: "POST",
        body: formData
      });

      if (!res.ok || !res.body) {
        bubble.innerHTML = "Something went wrong.";
        return;
      }

      const reader = res.body.getReader();
      const decoder = new TextDecoder();
      let fullText = '';
      bubble.innerHTML = '';

      while (true) {
        const { done, value } = await reader.read();
        if (done) break;
        const chunk = decoder.decode(value, { stream: true });
        fullText += chunk;
        bubble.innerHTML = formatBotText(fullText);
        chatBox.scrollTop = chatBox.scrollHeight;
      }
    });

    fetchFiles();
  </script>
</body>

</html>